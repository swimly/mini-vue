## 打包环境

在开始我们的项目之前，首先要做的当然是搭建开发环境，下面，我们先来了解我们需要哪些功能，然后根据对应的功能来配置环境。

- `node`环境，这个是必须的，现在也没有几个项目说没用到nodejs了。
- `jest`测试，为了写出更严谨的代码，单元测试可以说是必须的了。
- `typescript`，相信现在都可以熟练掌握ts了，用它来写代码实在太爽了。

在这里，我们就省略`node`的安装了，默认已经安装好`node`环境，并且安装好了包管理`npm`、`cnpm`或者`yarn`了。

下面，我们就一起一步步来创建我们的项目结构

### 初始化项目

通过`yarn`初始化`node`项目，自动生成`package.json`文件。

``` bash
yarn init -y
```

这时候，我们的项目目录除了`package.json`，还啥都没有，接下来，我们就来规定一下我们的目录结构。

### 目录结构

我们约定所有的项目代码都放在`src`目录下，然后根据不同的模块分为`reactivity`，`runtime-core`，`runtime-dom`等等，每个模块里面都有一个`tests`目录，用来存放该模块下的测试用例。

- src
  - reactivity
    - tests
      - index.spec.ts
    - index.ts
    - ...
  - ...
- package.json

### 测试用例

为了测试我们的环境，首先编写一个简单的测试用例

``` javascript
//src/ractivity/tests/index.spec.ts
describe("init", () => {
  expect(true).toBe(true)
})
```

<img src="doc/img/01.png" style="width: 300px;"/>

好巧不巧，写完之后这个测试文件会报错，因为我们的项目压根都还没配置`typescript`，而我们已经开始用`ts`文件来编写测试用例了。

### 集成typescript

首先，在我们的项目下安装`typescript`，安装到`dev`环境即可

``` bash
cnpm i -D typescript
```

现在，我们就可以在项目根目录下执行`tsc`命令

``` bash
npx tsc --init
```

这里，可能有人会问，`npx`是什么，这个可以自行百度，这里简单说下，就是为了让我们在项目根目录下执行`tsc`命令的时候不会找不到该命令。

如果实在搞不明白，这里也可以全局安装一下`cnpm i -g typescript`，然后执行`tsc --init`，二者效果是一样的。

这时候会给我们生成一个`tsconfig.json`，我们可以清理一下里面的注释，因为看起来太乱了。

``` javascript
// tsconfig.json
{
  "compilerOptions": {
    "target": "es5",
    "module": "commonjs",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

上面就是默认给我们创建的`ts`配置文件。

### 安装Jest

有了`ts`的支持，下面，我们继续集成`jest`开发环境

``` bash
cnpm i -D jest @types/jest
```

安装完后，我们上面写的单测依然报错，下面我们修改一下`tsconfig.json`文件。

``` javascript
{
  ...,
  "types": ["jest"]
}
```

修改完之后，我们的报错就解决了。

### 执行测试

配置好测试环境以及`typescript`环境后，我们再来给`package.json`添加一个`scripts`。

``` javascript
"scripts": {
  "test": "jest"
}
```

当我们执行`yarn test`之后，可以看到命令行显示测试通过，这里只是一个很简单的测试用例，如果我们需要在测试文件中引入其他模块呢？

### 支持Es6模块导入

接下来，按照我们项目的要求，先简单编写一个模块并导出，最后在测试文件中导入，看能不能通过测试

``` javascript
// src/reactivity/index.ts
export function add (a, b) {
  return a + b
}
```

?> 注意：这时候`vscode`会报错，只需要给`tsconfig.json`添加`"noImplicitAny": false`即可

``` javascript
// src/reactivity/tests/index.spec.ts
import {add} from '../index'
it("init", () => {
  expect(add(1, 1)).toBe(2)
})
```

不出意外，当我们再次执行`yarn test`会直接报错。

<img src="doc/img/02.png" style="width: 300px;"/>

因为`jest`默认的运行环境是`nodejs`，而node是`commonjs`规范，上面我们模块的导出和引入却用的是`esm`规范，所以，我们需要将它进行转换。

### babel配置

jest官方文档便有`babel`的配置方法, [https://www.jestjs.cn/docs/getting-started#%E4%BD%BF%E7%94%A8-babel](https://www.jestjs.cn/docs/getting-started#%E4%BD%BF%E7%94%A8-babel)

首先，按照上面的介绍安装所需依赖

``` bash
cnpm i -D babel-jest @babel/core @babel/preset-env @babel/preset-typescript
```

创建并配置`bebel`

``` javascript
//babel.config.js
module.exports = {
  presets: [
    [
      "@babel/preset-env",
      {
        targets: {
          node: "current"
        }
      }
    ],
    "@babel/preset-typescript"
  ]
}
```

到这里，`jest`测试环境就搭建好了，接下来，还要解决项目打包问题，这里我们采用`rollup`对我们的项目进行打包。

?> 分析：为什么会采用`rollup`，而不是`webpack`或者其他的打包工具，这里不做过多讲解，记住一句，`rollup`适合用来打包库，它默认支持`TreeShaking`，打包出来的代码很简洁，而且有丰富的`plugins`供使用。

### rollup集成

首先，安装`rollup`依赖，它支持命令行和api两种调用形式，这里，我们就用命令行来对项目进行打包

``` bash
cnpm i -D rollup @rollup/plugin-typescript tslib
```

并且创建一个配置文件`rollup.config.js`

``` javascript
import typescript from '@rollup/plugin-typescript'
export default {
  input: './src/index.ts',  //入口
  output: [{
    file: 'dist/index.cjs.js',
    format: 'cjs'
  }, {
    file: 'dist/index.esm.js',
    format: 'es'
  }],
  plugins: [
    typescript()
  ]
}
```

添加`scripts`

``` javascript
//package.json
"scripts": {
  ...,
  "dev": "rollup -wc"
}
```

修改`tsconfig.json`，将`module`的值改成`esnext`，当我们执行`yarn dev`的时候就能成功打包了。

### 总结

这一节，我们通过`jest`，`typescript`，`rollup`配置好了项目开发环境的测试以及代码打包，接下来，我们就可以一步步类实现我们的项目代码。

下一节，我们将一起来了解`vue3`最核心的`reactive`响应式对象。